<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scuba Wrapped</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --accent: #fc4c02;
      --accent-2: #ff7847;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --font: "Futura", "Jersey 25", "Trebuchet MS", "Futura", "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(252,76,2,0.12), transparent 25%), radial-gradient(circle at 80% 10%, rgba(255,120,71,0.12), transparent 20%), var(--bg);
      color: var(--text);
      font-family: var(--font);
      display: grid;
      place-items: center;
      padding: 24px;
    }
    .shell {
      width: min(1200px, 100%);
      background: var(--panel);
      border: 1px solid #1f2937;
      border-radius: 18px;
      padding: 24px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.35);
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 20px;
      align-items: start;
    }
    h1 {
      margin: 0 0 6px;
      font-size: 28px;
      letter-spacing: -0.02em;
    }
    p { margin: 6px 0 18px; color: var(--muted); }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 18px;
      align-items: stretch;
    }
    .control-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
      color: var(--muted);
    }
    input[type="file"], input[type="number"], input[type="text"], select {
      background: #0b1220;
      color: var(--text);
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 14px;
    }
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 32px;
      background-image: linear-gradient(45deg, transparent 50%, #94a3b8 50%), linear-gradient(135deg, #94a3b8 50%, transparent 50%);
      background-position: calc(100% - 16px) calc(50% - 3px), calc(100% - 10px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    input[type="number"] { width: 110px; }
    button {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b0b0b;
      font-weight: 700;
      letter-spacing: 0.02em;
      transition: transform 120ms ease, box-shadow 120ms ease;
      box-shadow: 0 12px 30px rgba(252,76,2,0.35);
    }
    button:active { transform: translateY(1px); box-shadow: 0 8px 20px rgba(252,76,2,0.25); }
    .status { margin: 8px 0 12px; color: var(--muted); font-size: 13px; }
    .help {
      margin: 0 0 12px;
      font-size: 13px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    .help a {
      color: var(--text);
      text-decoration: none;
      padding: 6px 10px;
      border: 1px solid #1f2937;
      border-radius: 8px;
      background: #0b1220;
    }
    .help a:hover {
      border-color: #334155;
    }
    .upload-btn {
      cursor: pointer;
      border: none;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b0b0b;
      font-weight: 700;
      letter-spacing: 0.02em;
      padding: 10px 14px;
      border-radius: 10px;
      box-shadow: 0 12px 30px rgba(252,76,2,0.35);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .upload-btn:active { transform: translateY(1px); box-shadow: 0 8px 20px rgba(252,76,2,0.25); }
    .file-input {
      display: none;
    }
    .table-wrap {
      max-height: 320px;
      overflow: auto;
      border: 1px solid #1f2937;
      border-radius: 12px;
      background: #0b1220;
      margin-top: 12px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: var(--text);
      font-size: 13px;
    }
    thead {
      background: #0f172a;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #1f2937;
    }
    th { text-align: left; color: var(--muted); }
    tbody tr:hover { background: rgba(255,255,255,0.03); }
    .render-output {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .render-img {
      width: min(450px, 100%);
      height: auto;
      border-radius: 16px;
      border: 1px solid #1f2937;
      background: #0b1220;
      display: block;
    }
    canvas {
      display: none;
    }
    .mobile-tip {
      color: var(--muted);
      font-size: 12px;
      text-align: center;
      display: none;
      margin-top: 8px;
    }
    @media (max-width: 1024px) {
      body { padding: 16px; }
      .shell {
        grid-template-columns: 1fr;
        width: 100%;
      }
      .controls {
        flex-direction: column;
      }
      .table-wrap {
        max-height: 40vh;
      }
      h1 {
        font-size: 24px;
      }
      .mobile-tip {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="shell">
    <div>
      <h1>Scuba Wrapped</h1>
      <div class="controls">
        <label>
          CSV file
          <div style="display:flex; gap:8px; align-items:center;">
            <button type="button" class="upload-btn" id="file-trigger">Upload CSV</button>
            <input id="file-input" class="file-input" type="file" accept=".csv" />
            <span style="color:var(--muted); font-size:12px;">(supports Garmin & Shearwater exports)</span>
          </div>
        </label>
        <label>
          Card title
          <input id="title-input" type="text" placeholder="${year} wrapped" style="margin-top:8px;" />
          <span style="color:var(--muted); font-size:12px;">Appears in the top-left of the image.</span>
        </label>
        <label>
          Year & color
          <div style="display:flex; gap:8px; align-items:center;">
            <input id="year-input" type="number" value="2025" min="1990" max="2100" />
            <select id="color-input" title="Change text color" aria-label="Change text color">
              <option value="white">White</option>
              <option value="black">Black</option>
              <option value="orange">Orange</option>
              <option value="yellow">Yellow</option>
              <option value="cyan">Cyan</option>
              <option value="magenta">Magenta</option>
              <option value="lime">Lime</option>
            </select>
          </div>
        </label>
      </div>
      <div class="status" id="status">Waiting for CSV...</div>
      <details class="help">
        <summary style="cursor:pointer;">Need help exporting?</summary>
        <div style="margin-top:6px; display:flex; flex-direction:column; gap:6px;">
          <details>
            <summary style="cursor:pointer;">Garmin</summary>
            <div style="margin-top:4px; display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <a href="https://support.garmin.com/en-US/?faq=NxZWyZYGqL17VNBMKDUjb5" target="_blank" rel="noreferrer">Garmin export guide</a>
            </div>
          </details>
          <details>
            <summary style="cursor:pointer;">Shearwater</summary>
            <div style="margin-top:4px; color:var(--muted); font-size:13px;">
              Export logbook CSV summary (include Max Depth / Max Time / Start Date columns).
            </div>
          </details>
        </div>
      </details>
      <details class="table-wrap" aria-label="Dive selection">
        <summary style="padding:8px 10px; cursor:pointer;">Pick your Dives</summary>
        <div style="padding: 0 10px 10px;">
          <table>
            <thead>
              <tr>
                <th style="width:40px;">Use</th>
                <th>Date</th>
                <th>Title</th>
              </tr>
            </thead>
            <tbody id="dive-rows">
              <tr><td colspan="3" style="text-align:center;color:var(--muted);">No CSV loaded</td></tr>
            </tbody>
          </table>
        </div>
      </details>
    </div>
    <div class="render-output">
      <img id="rendered-img" class="render-img" alt="Scuba summary preview (long-press to save)" title="Long-press to save on mobile" />
      <canvas id="card" width="1440" height="2560" aria-label="Dive summary card"></canvas>
    </div>
    <div class="mobile-tip" aria-hidden="true">Tip: long-press the image to download on mobile.</div>
  </div>
  <script>
    const state = {
      rows: [],
      headers: [],
      summary: null,
      selected: []
    };

    const statusEl = document.getElementById("status");
    const canvas = document.getElementById("card");
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false;
    const tbodyEl = document.getElementById("dive-rows");
    const renderedImg = document.getElementById("rendered-img");
    const fileTrigger = document.getElementById("file-trigger");
    const yearInput = document.getElementById("year-input");
    const titleInput = document.getElementById("title-input");

    fileTrigger.addEventListener("click", () => document.getElementById("file-input").click());
    document.getElementById("file-input").addEventListener("change", handleFile);
    document.getElementById("color-input").addEventListener("change", updateAndRender);
    yearInput.addEventListener("input", updateAndRender);
    titleInput.addEventListener("input", updateAndRender);

    function setStatus(msg) {
      statusEl.textContent = msg;
    }

    function handleFile(event) {
      const file = event.target.files?.[0];
      if (!file) return;
      if (file.type && file.type !== "text/csv" && file.type !== "application/vnd.ms-excel") {
        setStatus("Please upload a CSV file.");
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const text = reader.result.toString();
          const rows = parseCSV(text.trim());
          if (!rows.length) throw new Error("No rows found");
          state.headers = rows.shift().map(h => h.trim());
          state.rows = rows;
          state.selected = rows.map(() => true);
          renderTable();
          setStatus(`Loaded ${rows.length} rows. ${rows.length} selected.`);
          updateAndRender();
        } catch (err) {
          console.error(err);
          setStatus("Problem reading CSV. Make sure it is a plain CSV export.");
        }
      };
      reader.readAsText(file);
    }

    // Minimal CSV parser that respects quoted fields and commas inside quotes.
    function parseCSV(text) {
      const rows = [];
      let current = [];
      let field = "";
      let inQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];
        if (char === '"' && inQuotes && next === '"') {
          field += '"';
          i++;
        } else if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === "," && !inQuotes) {
          current.push(field);
          field = "";
        } else if ((char === "\n" || char === "\r") && !inQuotes) {
          if (field || current.length) {
            current.push(field);
            rows.push(current);
            current = [];
            field = "";
          }
        } else {
          field += char;
        }
      }
      if (field || current.length) {
        current.push(field);
        rows.push(current);
      }
      return rows.filter(r => r.some(cell => cell.trim().length));
    }

    function summarize(rows, headers, year) {
      const find = names => headers.findIndex(h => names.includes(h.toLowerCase()));
      const dateIdx = find(["date", "start date"]);
      const diveTimeIdx = find(["time", "dive time", "max time"]);
      const maxDepthIdx = find(["max depth", "depth"]);

      if (dateIdx === -1 || diveTimeIdx === -1 || maxDepthIdx === -1) {
        throw new Error("CSV missing Date/Start Date, Time/Dive Time/Max Time, or Max Depth columns.");
      }

      let count = 0;
      let totalTime = 0;
      let longest = 0;
      let totalDepth = 0;
      let depthCount = 0;
      let maxDepth = 0;

      for (const row of rows) {
        const dateStr = row[dateIdx];
        const dt = parseDate(dateStr);
        if (!dt || dt.getFullYear() !== year) continue;

        let diveSeconds = parseDuration(row[diveTimeIdx]);
        if (!Number.isFinite(diveSeconds) || diveSeconds <= 0) {
          const numeric = parseNumber(row[diveTimeIdx]);
          if (Number.isFinite(numeric) && numeric > 0) {
            // Heuristic: Shearwater Max Time exported in minutes
            diveSeconds = numeric < 1000 ? numeric * 60 : numeric;
          }
        }
        if (!Number.isFinite(diveSeconds) || diveSeconds <= 0) continue;

        count += 1;
        totalTime += diveSeconds;
        if (diveSeconds > longest) longest = diveSeconds;

      const depth = parseNumber(row[maxDepthIdx]);
        if (Number.isFinite(depth) && depth > 0) {
          totalDepth += depth;
          depthCount += 1;
          if (depth > maxDepth) maxDepth = depth;
        }
      }

      const avgTime = count ? totalTime / count : 0;
      const avgDepth = depthCount ? totalDepth / depthCount : 0;

      setStatus(`Found ${count} dives in ${year} (selected rows only).`);
      return {
        count,
        totalTime,
        avgTime,
        longest,
        avgDepth,
        maxDepth
      };
    }

    function parseDate(value) {
      if (!value) return null;
      const parsed = new Date(value);
      if (!Number.isNaN(parsed.getTime())) return parsed;
      // Fallback for MM/DD/YYYY
      const parts = value.split(/[/-]/).map(p => parseInt(p, 10));
      if (parts.length >= 3) {
        const [m, d, y] = parts;
        return new Date(y, m - 1, d);
      }
      return null;
    }

    function parseDuration(value) {
      if (!value) return NaN;
      const cleaned = value.toString().trim();
      const parts = cleaned.split(":").map(p => parseFloat(p));
      if (parts.some(n => Number.isNaN(n))) return NaN;
      if (parts.length === 3) {
        const [h, m, s] = parts;
        return h * 3600 + m * 60 + s;
      }
      if (parts.length === 2) {
        const [m, s] = parts;
        return m * 60 + s;
      }
      return parseFloat(cleaned);
    }

    function parseNumber(value) {
      if (value == null) return NaN;
      const cleaned = value.toString().replace(/[^\d.+-]/g, "");
      const num = parseFloat(cleaned);
      return Number.isFinite(num) ? num : NaN;
    }

    function sanitizeText(value) {
      return String(value ?? "").replace(/[\u0000-\u001F\u007F]/g, "");
    }

    function formatMinutes(seconds) {
      const mins = seconds / 60;
      return `${mins.toFixed(1)} min`;
    }

    function formatDurationLong(seconds) {
      if (!Number.isFinite(seconds)) return "0";
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      const s = Math.floor(seconds % 60);
      if (h > 0) return `${h}h ${m}m`;
      if (m > 0) return `${m}m ${s}s`;
      return `${s}s`;
    }

    function renderTable() {
      const headerLower = state.headers.map(h => h.toLowerCase());
      const dateIdx = headerLower.findIndex(h => h === "date" || h === "start date");
      const titleIdx = headerLower.findIndex(h => h === "title" || h === "dive number");
      if (!state.rows.length || dateIdx === -1) {
        tbodyEl.innerHTML = `<tr><td colspan="3" style="text-align:center;color:var(--muted);">No dives to display</td></tr>`;
        return;
      }
      const fragment = document.createDocumentFragment();
      state.rows.forEach((row, idx) => {
        const tr = document.createElement("tr");

        const tdCheck = document.createElement("td");
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = state.selected[idx];
        checkbox.addEventListener("change", () => {
          state.selected[idx] = checkbox.checked;
          const count = state.selected.filter(Boolean).length;
          setStatus(`Loaded ${state.rows.length} rows. ${count} selected.`);
          updateAndRender();
        });
        tdCheck.appendChild(checkbox);
        tr.appendChild(tdCheck);

        const tdDate = document.createElement("td");
        tdDate.textContent = sanitizeText(row[dateIdx]);
        tr.appendChild(tdDate);

        const tdTitle = document.createElement("td");
        tdTitle.textContent = titleIdx !== -1 ? sanitizeText(row[titleIdx]) : "";
        tr.appendChild(tdTitle);

        fragment.appendChild(tr);
      });
      tbodyEl.innerHTML = "";
      tbodyEl.appendChild(fragment);
    }

    function renderWithFonts(summary, year, statusMsg) {
      const ready = document.fonts?.ready;
      const draw = () => {
        drawCard(summary, year);
        if (statusMsg) setStatus(statusMsg);
      };
      if (ready && typeof ready.then === "function") {
        ready.then(draw).catch(draw);
      } else {
        draw();
      }
    }

    function drawCard(summary, year) {
      const { count, totalTime, avgTime, longest, avgDepth, maxDepth } = summary;
      ctx.clearRect(0, 0, canvas.width, canvas.height); // transparent background only

      ctx.save();
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      const color = document.getElementById("color-input").value || "white";
      ctx.fillStyle = color;

      const col1X = canvas.width * 0.25;
      const col2X = canvas.width * 0.75;
      const colWidth = canvas.width * 0.3;
      const rowHeight = canvas.height * 0.1;
      const row1Y = canvas.height * 0.14;
      const row2Y = row1Y + rowHeight;
      const row3Y = row2Y + rowHeight;
      const row4Y = row3Y + rowHeight;

      const titleInputEl = document.getElementById("title-input");
      const customTitle = titleInputEl?.value?.trim() ? titleInputEl.value.trim() : `${year} wrapped`;

      const row1Bottom = row1Y + rowHeight - 50; // 50px padding from bottom of row 1

      // Row 1, Col 1: custom title (center, bottom aligned)
      ctx.textBaseline = "bottom";
      ctx.font = "68px 'Futura', 'Trebuchet MS', 'Futura', 'Segoe UI', sans-serif";
      ctx.textAlign = "center";
      ctx.fillText(customTitle, col1X, row1Bottom);

      // Row 1, Col 2: icon + SCUBA (center aligned within column, bottom aligned)
      ctx.textAlign = "left";
      ctx.font = "68px 'Futura', 'Trebuchet MS', 'Futura', 'Segoe UI', sans-serif";
      const scubaText = "SCUBA";
      const scubaWidth = ctx.measureText(scubaText).width;
      const logoScale = 0.65;
      const logoWidth = 122.88 * logoScale;
      const logoHeight = 121.21 * logoScale;
      const gap = 14;
      const col2Center = col2X;
      const totalWidth = logoWidth + gap + scubaWidth;
      const iconX = col2Center - totalWidth / 2;
      const iconY = row1Bottom - logoHeight;
      if (!drawCard.scubaPath) {
        drawCard.scubaPath = new Path2D("M100.07,67.24c-.44-10.1-3-13.34-6.11-13.38A59.88,59.88,0,0,1,93.86,80c3.5.24,5.78-3.94,6.21-12.77Zm18.27-47.48a4.54,4.54,0,1,1-4.53,4.53,4.53,4.53,0,0,1,4.53-4.53ZM109,0a7.23,7.23,0,1,1-7.22,7.22A7.22,7.22,0,0,1,109,0ZM18.12,87.85Zm45,2.47A10.29,10.29,0,1,1,52.83,100.6,10.29,10.29,0,0,1,63.11,90.32ZM9.66,69.89a6.14,6.14,0,0,1,3.09-2v-.34a63.9,63.9,0,0,1,1-10.52,16.18,16.18,0,0,1,4-9.2l.48-.5-1.43-.46c-2-62.7,96.25-54.49,94.79.4,0,.65,0,1.28-.11,1.88a14.68,14.68,0,0,1,2.37,8,55.7,55.7,0,0,1,1.06,10.4,46.07,46.07,0,0,1-1.05,10c-.1,5-1.71,8.52-4.59,10.91a12.08,12.08,0,0,1-4.78,2.41,43,43,0,0,1-8.84,15.58A43.87,43.87,0,0,1,81,117.25a41.53,41.53,0,0,1-17.13,3.8,35.7,35.7,0,0,1-16.47-3.92,35,35,0,0,1-28.06,2.07A30.84,30.84,0,0,1,6.85,111,26.13,26.13,0,0,1,.29,97.17C-.92,89,1.58,79.58,9.66,69.89Zm8.89-.56a.86.86,0,0,1,0,.8,56.09,56.09,0,0,0,.66,6.47,1,1,0,0,1,.13.78l.1.52c.72,5.21,3.6,7.5,7.89,7.89H43.43c10.35-.58,11.64-6.27,16.12-8.67a9.92,9.92,0,0,1,9.5.29c4.06,2.6,5.4,8.1,14.82,8.1H98.39c6.11.65,9.72-1.74,9.65-8.6a44.4,44.4,0,0,0,0-19.17c0-6.14-3.67-8.55-9.23-9H27.22c-4.23,1.18-7.11,3.86-7.75,9a56.23,56.23,0,0,0-.92,11.59ZM15.12,83.64C12.74,88,12,92,12.52,95.38A13.88,13.88,0,0,0,16,102.69a18.54,18.54,0,0,0,7.48,4.91,22.36,22.36,0,0,0,12.51.69C31.55,104,28.23,100.14,25.9,95.8A31.57,31.57,0,0,1,23.8,91a13,13,0,0,1-8.68-7.36Zm48,1.06a15.91,15.91,0,1,1-15.9,15.9,15.9,15.9,0,0,1,15.9-15.9Z");
      }
      ctx.save();
      ctx.translate(iconX, iconY);
      ctx.scale(logoScale, logoScale);
      ctx.fill(drawCard.scubaPath);
      ctx.restore();
      ctx.fillText(scubaText, iconX + logoWidth + gap, row1Bottom);

      // reset baseline for remaining rows
      ctx.textBaseline = "top";

      // Stats rows (rows 2-4)
      const labelSize = 45;
      const valueSize = 100;
      const statsCol1 = canvas.width * 0.3;
      const statsCol2 = canvas.width * 0.7;
      drawStat(statsCol1, row2Y, "Total Dives", count.toString(), labelSize, valueSize, "center");
      drawStat(statsCol2, row2Y, "Total Dive Time", formatDurationLong(totalTime), labelSize, valueSize, "center");
      drawStat(statsCol1, row3Y, "Average Dive Time", formatMinutes(avgTime), labelSize, valueSize, "center");
      drawStat(statsCol2, row3Y, "Max Depth", `${maxDepth.toFixed(1)} m`, labelSize, valueSize, "center");
      drawStat(statsCol1, row4Y, "Average Depth", `${avgDepth.toFixed(1)} m`, labelSize, valueSize, "center");
      drawStat(statsCol2, row4Y, "Max Dive Time", formatMinutes(longest), labelSize, valueSize, "center");

      // CTA just below stats
      const ctaY = row4Y + valueSize + 100;
      ctx.font = "37px 'Futura', 'Trebuchet MS', 'Futura', 'Segoe UI', sans-serif";
      ctx.fillStyle = color;
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText("Get yours at bit.ly/divewrapped", canvas.width / 2, ctaY);

      ctx.restore();

      // Update visible image for long-press save on mobile
      if (renderedImg) {
        const url = canvas.toDataURL("image/png");
        renderedImg.src = url;
        renderedImg.alt = `Scuba summary for ${year}`;
      }
    }

    function drawStat(x, y, label, value, labelSize, valueSize, align = "left") {
      ctx.textAlign = align;
      ctx.font = `${labelSize}px 'Futura', 'Trebuchet MS', 'Futura', 'Segoe UI', sans-serif`;
      ctx.fillText(label, x, y);
      ctx.font = `${valueSize}px 'Futura', 'Trebuchet MS', 'Futura', 'Segoe UI', sans-serif`;
      ctx.fillText(value, x, y + labelSize + 3); // 3px spacing
    }

    function updateAndRender() {
      if (!state.rows.length) {
        setStatus("Please load a CSV first.");
        return null;
      }
      const year = parseInt(document.getElementById("year-input").value, 10);
      const activeRows = state.rows.filter((_, idx) => state.selected[idx]);
      state.summary = summarize(activeRows, state.headers, year);
      renderWithFonts(state.summary, year, `Rendered image with ${state.summary.count} dives in ${year}.`);
      return state.summary;
    }

    renderWithFonts({ count: 0, totalTime: 0, avgTime: 0, longest: 0, avgDepth: 0, maxDepth: 0 }, new Date().getFullYear());
  </script>
</body>
</html>
